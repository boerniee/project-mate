{% extends "base.html" %}

{% block app_content %}
  <div><h1><div style="float:left;">{{ _('Dashboard') }}</div><button id="billingstart" class="btn btn-primary" style="margin-left: 25px;display:inline;" type="button">{{ _('Starte Abrechnung') }}</button><div style="float:right;">{{ _('Offen:') + ' ' + open }}</div></h1></div>

  <table class="table table-hover">
    <thead>
      <tr>
        <th scope="col">#</th>
        <th scope="col">{{ _('Benutzername') }}</th>
        <th scope="col">{{ _('Anzahl') }}</th>
        <th scope="col">{{ _('Kosten') }}</th>
      </tr>
    </thead>
    <tbody>
    {% for con in consumptions %}
      <tr data-toggle="modal" data-target="#exampleModal" data-user="{{ con[0].username }}" data-id="{{ con[0].id }}">
        <td>{{ loop.index }}</td>
        <td>{{ con[0].username }}</td>
        <td>{{ con.amount }}</td>
        <td>{{ format_curr(con.sum) }}</td>
      </tr>
    {% endfor %}
    </tbody>
  </table>
{#
  <nav aria-label="Page navigation">
    <ul class="pagination justify-content-center">
      {%- for page in consumptions.iter_pages() %}
          {% if page %}
            {% if page != consumptions.page %}
              <li class="page-item"><a class="page-link" href="{{ url_for('main.admindashboard', page=page) }}">{{ page }}</a></li>
            {% else %}
            <li class="page-item active">
              <a class="page-link" href="#">{{ page }} <span class="sr-only">(current)</span></a>
            </li>
            {% endif %}
          {% else %}
            <li class="page-item"><a class="page-link" href="#">...</a></li>
          {% endif %}
        {%- endfor %}
      </ul>
    </nav>#}

    <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="exampleModalLabel">New message</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th scope="col">{{ _('Produkt') }}</th>
                  <th scope="col">{{ _('Anzahl') }}</th>
                  <th scope="col">{{ _('Preis') }}</th>
                  <th scope="col">{{ _('Datum') }}</th>
                </tr>
              </thead>
              <tbody id="detailbody">
              </tbody>
            </table>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Fertig</button>
          </div>
        </div>
      </div>
    </div>
{% endblock %}

{% block custom_script %}
  <script>
    $("#admindashboard").addClass('active');

    $('#exampleModal').on('show.bs.modal', function (event) {
      var button = $(event.relatedTarget) // Button that triggered the modal
      var id = button.data('id')
      var user = button.data('user')
      var modal = $(this)
      modal.find('.modal-title').text('Detailauswertung: ' + user)
      modal.find('.modal-body input').val(id)

      $.ajax({
        url: "{{ url_for('main.consumptions', id=0) }}".replace('0', id),
        dataType: "json"
      }).done(
        function(data) {
          var sel = $("#detailbody");
          sel.empty();
          for (var i=0; i<data['consumptions'].length; i++) {
            sel.append('<tr><td>' + data['consumptions'][i]['product']['description'] + "</td><td>" + data['consumptions'][i]['amount'] + "</td><td>" + data['consumptions'][i]['price'] + "</td><td>" + data['consumptions'][i]['datetime'] + "</td></tr>");
          }
        }
      );
    })

    function updateButton(id, button) {
      $.getJSON("{{ url_for('main.get_task_status', id='ID') }}".replace('ID', id), function(data) {
        console.log(data['state'])
        if (data['state'] != 'PENDING' && data['state'] != 'PROGRESS') {
          button.addClass('btn-success');
          button.html('<i class="fa fa-check"></i> {{ _('Erfolgreich durchgeführt') }}');
        } else {
          setTimeout(function() {
                    updateButton(id, button);
                }, 2000);
        }
      }
    );
  }

    $('#billingstart').on('click', function() {
      var $this = $(this);
      var taskid;
      var loadingText = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> {{ _('das ähh läuft...') }}';
      if ($this.html() !== loadingText) {
        $this.data('original-text', $(this).html());
        $this.html(loadingText);
        $this.removeClass('btn-success');
      }
      $.ajax("{{ url_for('main.billing') }}" )
      .done(function(data) {
        taskid = data['id'];
        updateButton(taskid, $this);
      })
      .fail(function() {
        console.log("{{ _('Fehler') }}")
      });
    });
  </script>
{% endblock %}
